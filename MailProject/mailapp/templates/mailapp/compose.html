{% extends 'mailapp/base.html' %}

{% block title %}Compose Message - MailApp{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1"><i class="fas fa-edit me-3 text-primary"></i>Compose Message</h2>
        <p class="text-muted mb-0">Create and send a new message</p>
    </div>
    <a href="{% url 'inbox' %}" class="btn btn-outline-modern">
        <i class="fas fa-arrow-left me-2"></i>Back to Inbox
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- AI Draft Generator Section -->
        <div class="card card-modern mb-4" id="ai-draft-section">
            <div class="card-header card-header-modern d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Draft Assistant</h5>
                <button type="button" class="btn btn-sm btn-outline-light btn-modern" id="toggle-ai-section">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div class="card-body" id="ai-draft-content">
                <div class="mb-3">
                    <label for="ai-prompt" class="form-label fw-semibold">Describe what you want to write:</label>
                    <textarea class="form-control form-control-modern" id="ai-prompt" rows="3" placeholder="e.g., Write a professional email to request a project update meeting for next week"></textarea>
                </div>
                <button type="button" class="btn btn-primary-modern" id="generate-ai-draft">
                    <i class="fas fa-magic me-2"></i>Generate Draft
                </button>
                <button type="button" class="btn btn-outline-modern ms-2" id="clear-ai-fields">
                    <i class="fas fa-eraser me-2"></i>Clear
                </button>
                
                <!-- Loading indicator -->
                <div id="ai-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <p class="mt-3 text-muted fw-medium">âœ¨ AI is crafting your perfect message...</p>
                </div>
                
                <!-- Error message -->
                <div id="ai-error" class="alert alert-danger alert-modern mt-3" style="display: none;"></div>
                
                <!-- Success message -->
                <div id="ai-success" class="alert alert-success alert-modern mt-3" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>Draft generated successfully! The content has been added to your compose form below.
                </div>
            </div>
        </div>
        
        <!-- Main Compose Form -->
        <div class="card card-modern">
            <div class="card-header card-header-modern">
                <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>New Message</h5>
            </div>
            <div class="card-body">
                <form method="post" id="compose-form">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger alert-modern mb-4">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Please fix the following errors:</strong>
                        <ul class="mb-0 mt-2">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>{{ field }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="{{ form.project.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-folder me-2 text-primary"></i>Project
                            </label>
                            {{ form.project }}
                            {% if form.project.errors %}
                                <div class="text-danger mt-1">{{ form.project.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.recipient.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-user me-2 text-primary"></i>Recipient
                            </label>
                            {{ form.recipient }}
                            {% if form.recipient.errors %}
                                <div class="text-danger mt-1">{{ form.recipient.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.subject.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-tag me-2 text-primary"></i>Subject
                        </label>
                        <input type="text" name="{{ form.subject.name }}" id="{{ form.subject.id_for_label }}" 
                               class="form-control form-control-modern" 
                               placeholder="Enter message subject..."
                               value="{{ form.subject.value|default:'' }}" required>
                        {% if form.subject.errors %}
                            <div class="text-danger mt-1">{{ form.subject.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.body.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-comment me-2 text-primary"></i>Message
                        </label>
                        <textarea name="{{ form.body.name }}" id="{{ form.body.id_for_label }}" 
                                  class="form-control form-control-modern" rows="8"
                                  placeholder="Write your message here..." required>{{ form.body.value|default:'' }}</textarea>
                        {% if form.body.errors %}
                            <div class="text-danger mt-1">{{ form.body.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="submit" name="action" value="send" class="btn btn-primary-modern btn-lg me-3">
                                <i class="fas fa-paper-plane me-2"></i>Send Message
                            </button>
                            <button type="submit" name="action" value="draft" class="btn btn-outline-modern">
                                <i class="fas fa-save me-2"></i>Save as Draft
                            </button>
                        </div>
                        <a href="{% url 'drafts' %}" class="btn btn-outline-modern">
                            <i class="fas fa-file-alt me-2"></i>View Drafts
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Function to load users for a project
    function loadProjectUsers(projectId, selectedRecipientId = null) {
        var recipientSelect = $('#id_recipient');
        
        // Clear current options
        recipientSelect.empty();
        recipientSelect.append('<option value="">Select Recipient</option>');
        
        if (projectId) {
            $.ajax({
                url: '{% url "get_project_users" %}',
                data: {
                    'project_id': projectId
                },
                success: function(data) {
                    if (data.users && data.users.length > 0) {
                        $.each(data.users, function(index, user) {
                            var option = '<option value="' + user.id + '"' + 
                                       (selectedRecipientId == user.id ? ' selected' : '') + 
                                       '>' + user.name + '</option>';
                            recipientSelect.append(option);
                        });
                    } else {
                        recipientSelect.append('<option value="">No users available</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching users for project:', error);
                    recipientSelect.append('<option value="">Error loading users</option>');
                }
            });
        }
    }
    
    // Load users on page load if project is already selected
    var initialProjectId = $('#id_project').val();
    var initialRecipientId = '{{ form.recipient.value|default:"" }}';
    if (initialProjectId) {
        loadProjectUsers(initialProjectId, initialRecipientId);
    }
    
    // Update recipients when project changes
    $('#id_project').change(function() {
        var projectId = $(this).val();
        loadProjectUsers(projectId);
    });
    
    // Auto-save as draft every 30 seconds
    var autoSaveInterval;
    
    function autoSave() {
        var formData = $('#compose-form').serialize() + '&action=draft';
        var project = $('#id_project').val();
        var subject = $('#id_subject').val();
        var body = $('#id_body').val();
        
        // Only auto-save if there's some content
        if (project && (subject || body)) {
            $.ajax({
                url: '{% url "compose" %}',
                method: 'POST',
                data: formData,
                success: function(response) {
                    // Show a subtle indication that draft was saved
                    showAutoSaveIndicator();
                },
                error: function() {
                    console.log('Auto-save failed');
                }
            });
        }
    }
    
    function showAutoSaveIndicator() {
        if (!$('#auto-save-indicator').length) {
            $('<small id="auto-save-indicator" class="text-muted float-end">Draft auto-saved</small>')
                .insertAfter('#id_subject')
                .delay(2000)
                .fadeOut(function() {
                    $(this).remove();
                });
        }
    }
    
    // Start auto-save when user starts typing
    $('#id_subject, #id_body').on('input', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
        autoSaveInterval = setInterval(autoSave, 30000); // Auto-save every 30 seconds
    });
    
    // Clear auto-save interval when form is submitted
    $('#compose-form').on('submit', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
    
    // AI Draft Generation Functionality
    $('#toggle-ai-section').click(function() {
        var content = $('#ai-draft-content');
        var icon = $(this).find('i');
        
        content.slideToggle();
        if (icon.hasClass('fa-chevron-up')) {
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        } else {
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }
    });
    
    $('#generate-ai-draft').click(function() {
        var prompt = $('#ai-prompt').val().trim();
        
        if (!prompt) {
            showAIError('Please enter a description of what you want to write.');
            return;
        }
        
        // Show loading state
        $('#ai-loading').show();
        $('#ai-error').hide();
        $('#ai-success').hide();
        $(this).prop('disabled', true);
        
        // Make AJAX request to generate AI draft
        $.ajax({
            url: '{% url "generate_ai_draft" %}',
            method: 'POST',
            data: {
                'prompt': prompt,
                'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Populate the form fields with AI-generated content
                    if (response.subject) {
                        $('#id_subject').val(response.subject);
                    }
                    if (response.body) {
                        $('#id_body').val(response.body);
                    }
                    
                    // Show success message
                    $('#ai-success').show();
                    
                    // Scroll to the form to show the generated content
                    $('html, body').animate({
                        scrollTop: $('#id_subject').offset().top - 100
                    }, 500);
                } else {
                    showAIError(response.error || 'Failed to generate AI draft.');
                }
            },
            error: function(xhr, status, error) {
                var errorMsg = 'Failed to generate AI draft.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showAIError(errorMsg);
            },
            complete: function() {
                $('#ai-loading').hide();
                $('#generate-ai-draft').prop('disabled', false);
            }
        });
    });
    
    $('#clear-ai-fields').click(function() {
        $('#ai-prompt').val('');
        $('#ai-error').hide();
        $('#ai-success').hide();
    });
    
    function showAIError(message) {
        $('#ai-error').text(message).show();
        $('#ai-success').hide();
    }
});
</script>
{% endblock %}
