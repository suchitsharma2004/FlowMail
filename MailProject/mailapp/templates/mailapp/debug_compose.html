{% extends 'mailapp/base.html' %}

{% block title %}Debug Compose{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Debug Compose Page</h2>
    
    <div class="row">
        <div class="col-md-6">
            <h4>User Projects:</h4>
            <ul>
                {% for project in user_projects %}
                    <li>{{ project.name }} (ID: {{ project.id }})</li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-6">
            <h4>Test AJAX Call:</h4>
            <button id="test-ajax" class="btn btn-primary">Test Get Project Users</button>
            <div id="ajax-result" class="mt-3"></div>
        </div>
    </div>
    
    <div class="mt-4">
        <h4>Test Dropdowns:</h4>
        <div class="row">
            <div class="col-md-6">
                <label>Project:</label>
                <select id="test-project" class="form-control">
                    <option value="">Select Project</option>
                    {% for project in user_projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label>Users:</label>
                <select id="test-users" class="form-control">
                    <option value="">Select User</option>
                </select>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Debug page loaded');
    
    $('#test-ajax').click(function() {
        $.ajax({
            url: '{% url "get_project_users" %}',
            data: {
                'project_id': '1'  // Test with project ID 1
            },
            success: function(data) {
                console.log('AJAX Success:', data);
                $('#ajax-result').html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
            },
            error: function(xhr, status, error) {
                console.log('AJAX Error:', error);
                $('#ajax-result').html('<div class="alert alert-danger">Error: ' + error + '</div>');
            }
        });
    });
    
    $('#test-project').change(function() {
        var projectId = $(this).val();
        console.log('Project changed to:', projectId);
        
        if (projectId) {
            $.ajax({
                url: '{% url "get_project_users" %}',
                data: {
                    'project_id': projectId
                },
                success: function(data) {
                    console.log('Users loaded:', data);
                    var usersSelect = $('#test-users');
                    usersSelect.empty();
                    usersSelect.append('<option value="">Select User</option>');
                    
                    $.each(data.users, function(index, user) {
                        var option = '<option value="' + user.id + '">' + user.name + '</option>';
                        usersSelect.append(option);
                    });
                },
                error: function(xhr, status, error) {
                    console.log('Error loading users:', error);
                }
            });
        } else {
            $('#test-users').empty().append('<option value="">Select User</option>');
        }
    });
});
</script>
{% endblock %}
